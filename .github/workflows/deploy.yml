name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Create production Firebase config
        run: |
          # –°–æ–∑–¥–∞–µ–º JavaScript —Ñ–∞–π–ª —Å –∫–æ–Ω—Ñ–∏–≥–æ–º –∏–∑ secrets
          cat > firebase-config-prod.js << 'EOF'
          // üîí AUTO-GENERATED CONFIG - DO NOT EDIT
          window.FIREBASE_CONFIG = {
            apiKey: "${{ secrets.FIREBASE_API_KEY }}",
            authDomain: "${{ secrets.FIREBASE_AUTH_DOMAIN }}",
            projectId: "${{ secrets.FIREBASE_PROJECT_ID }}",
            storageBucket: "${{ secrets.FIREBASE_STORAGE_BUCKET }}",
            messagingSenderId: "${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}",
            appId: "${{ secrets.FIREBASE_APP_ID }}"
          };
          console.log('üöÄ Production Firebase config loaded via GitHub Secrets');
          EOF

      - name: Replace config in HTML
        run: |
          # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª —Å –ø–æ–¥—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
          cat > index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="ru">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>–ú–æ–∏ –ó–∞–º–µ—Ç–∫–∏</title>
              <link rel="stylesheet" href="styles.css">
              <link rel="manifest" href="manifest.json">
              <meta name="theme-color" content="#4f46e5">
              
              <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
              <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
              <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
          </head>
          <body>
              <div class="container">
                  <header>
                      <h1>üìù –ú–æ–∏ –ó–∞–º–µ—Ç–∫–∏</h1>
                      <div class="header-actions">
                          <div id="user-info" style="display: none;">
                              <span id="user-email" style="margin-right: 15px;"></span>
                              <button id="theme-toggle" class="btn btn-secondary" style="margin-right: 10px;">üåô</button>
                              <button id="logout-btn" class="btn btn-secondary">–í—ã–π—Ç–∏</button>
                          </div>
                          <button id="install-btn" class="install-btn" style="display: none;">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
                      </div>
                  </header>

                  <div id="auth-screen" class="auth-screen">
                      <div class="auth-container">
                          <h2>–í—Ö–æ–¥ –≤ –ó–∞–º–µ—Ç–∫–∏</h2>
                          <form id="auth-form">
                              <input type="email" id="email" placeholder="Email" required>
                              <input type="password" id="password" placeholder="–ü–∞—Ä–æ–ª—å" required>
                              <button type="submit" id="login-btn" class="btn btn-primary">–í–æ–π—Ç–∏</button>
                              <button type="button" id="signup-btn" class="btn btn-secondary">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
                          </form>
                          <div id="auth-message" class="auth-message"></div>
                      </div>
                  </div>

                  <div id="app-screen" style="display: none;">
                      <div class="categories-panel">
                          <div class="categories-header">
                              <h3>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</h3>
                              <button id="add-category-btn" class="btn btn-secondary">+</button>
                          </div>
                          <div id="categories-list" class="categories-list">
                              <button class="category-btn active" data-category="all">–í—Å–µ –∑–∞–º–µ—Ç–∫–∏</button>
                          </div>
                      </div>

                      <div class="main-content">
                          <div class="editor">
                              <textarea id="note-text" placeholder="–ù–∞—á–Ω–∏—Ç–µ –ø–∏—Å–∞—Ç—å –∑–∞–º–µ—Ç–∫—É..."></textarea>
                              <div class="editor-actions">
                                  <select id="category-select" class="category-select">
                                      <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
                                  </select>
                                  <button id="save-btn" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                                  <button id="clear-btn" class="btn btn-secondary">–û—á–∏—Å—Ç–∏—Ç—å</button>
                              </div>
                          </div>

                          <div class="notes-list">
                              <h2 id="notes-title">–ú–æ–∏ –∑–∞–º–µ—Ç–∫–∏</h2>
                              <div id="notes-container"></div>
                          </div>
                      </div>
                  </div>
              </div>

              <div id="category-modal" class="modal">
                  <div class="modal-content">
                      <h3>–ù–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è</h3>
                      <input type="text" id="category-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏" maxlength="100">
                      <input type="color" id="category-color" value="#4f46e5">
                      <div class="modal-actions">
                          <button id="cancel-category-btn" class="btn btn-secondary">–û—Ç–º–µ–Ω–∞</button>
                          <button id="create-category-btn" class="btn btn-primary">–°–æ–∑–¥–∞—Ç—å</button>
                      </div>
                  </div>
              </div>

              <script src="firebase-config-prod.js"></script>
              <script src="firebase-config.js"></script>
              <script src="app.js"></script>
          </body>
          </html>
          EOF
          
          echo "‚úÖ Production HTML created with secure Firebase config"

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: .

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4